%======================================================================
\chapter{Stable Matching Polytope}
%======================================================================
\paragraph{}
In this we focus on a polyhedral characterization of the set of
incidence vectors of stable matchings.  Vande Vate first provided such
a description in \cite{vate1989linear} for the special case where $G$
is a complete bipartite graph.  Rothblum \cite{rothblum1992characterization} later generalized Vande Vate's result to incomplete preference lists and simplified the proof of integrality via an extreme point argument.
\paragraph{}
We provide an even simpler, more compact argument for the integrality of Rothblum's formulation. Our arguments are elementary and rely solely on some well-known results on the symmetric difference of stable matchings as well as some knowledge of the local structure of extreme points in our formulation to achieve the desired result. This proof operates in the spirit of iterative rounding as discussed in \ref{IR}. We say it is iterative rounding in spirit because, while it does not follow the strict approach of iterative rounding, it proves that there is an integral variable in every extreme point and analyses the result of dropping that variable and applying induction to the smaller problem instance to obtain a contradiction.
\section{Linear Description}
\paragraph{Notation}
We will use some notation to ease exposition. Suppose $G=(A\cup B, E)$ is a bipartite graph. Let $S \subseteq E$ and let $x \in \R^{\size{E}}$. Then we denote $\sum_{e\in S} x_e$ by $x(S)$. Suppose $A \cup B$ have preference orders as in a stable matching instance. Then we for any $a\in A$ and $b \in B$ we let
$$\delta^{>a}(b) = \{a' \in A: a' >_b a\}.$$
We can define $\delta^{>b}(a)$ analogously, and further replace $>$ with $<, \leq, \geq, =$ in the natural way.
\paragraph{Linear Description}
We will begin with a linear description of a polytope which we claim has incidence vectors of stable matchings as its extreme points. This polytope is the matching polytope described in \ref{GT:MWM} with added "stability" constraints. If we let $G=(A\cup B, E)$ be a bipartite graph with preferences then we will denote the so-called stable matching polytope of $G$ by $P(G)$ and it has the following description:
\begin{align}
x(\delta(v)) &\leq 1, &\text{for all } v \in A\cup B \label{constraint:one}\\
x_e &\geq 0, &\text{for all } e \in E \label{constraint:nonneg}\\
x(\delta^{>a}(b)) + x(\delta^{>b}(a)) + x_{ab} &\geq 1, &\text{for all } ab \in E.\label{constraint:stab}
\end{align}
Our major theorem of this chapter is to demonstrate that $P(G)$ is integral, but first we must verify that indeed the integral extreme points of $P(G)$ are exactly the incidence vectors of stable matchings in $G$.
\begin{lemma}\label{lemma:int-P}
Let $x \in \R^{\size{E}}$. Then $x$ is an integral extreme point of $P(G)$ if and only if there exists a stable matching $M$ of $G$ such that $x = \chi(M)$.
\end{lemma}
\begin{proof}
\paragraph{}
Suppose that $x$ is an integral extreme point of $P(G)$. By constraints \ref{constraint:one} and \ref{constraint:nonneg} and Birkhoff's theorem \cite{birkhoff1946tres}, $x$ is the incidence vector of some matching $M$ of $G$. Suppose that $M$ is not stable, that is to say there exists $ab \in E$ which blocks $M$. But $ab$ satisfies:
$$x(\delta^{>a}(b)) + x(\delta^{>b}(a)) + x_{ab} \geq 1$$
and since $x$ is integral, $ab \not\in M$ this implies that either
$$x(\delta^{>a}(b)) = 1 \quad\text{or}\quad  x(\delta^{>b}(a)) = 1.$$
In the first case there exists $b'$ for which $x_{ab'} = 1$ and hence $ab' \in M$  with $b' >_a b$. Thus in the first case $ab$ does not block $M$. Similarly in the second case there exists $a' >_b a$ with $a'b \in M$ and hence $ab$ does not block $M$ in either case. Therefore $M$ is stable.
\paragraph{}
Now suppose there exists a stable matching $M$ of $G$ for which $x = \chi(M)$. Since $M$ is a matching $x(\delta(v) \leq 1$ for all $v \in A \cup B$ and $x_e \geq 0$ for all $e \in E$. Hence it remains to verify that $x$ satisfies constraints \ref{constraint:stab}. Indeed let $ab \in E$. If $ab \in M$ then $1 = \chi(M)_{ab} = x_{ab}$ and so \ref{constraint:stab} is satisfied for $ab$. Now if $ab \not\in M$ then, since $M$ is stable, $(a,b)$ is not a blocking pair. So there exists $ab' \in M$ with $b' >_a b$ or there exists $a'b \in M$ with $a' >_b a$. In the former case $x(\delta^{>b}(a)) \geq 1$ and in the latter $x(\delta^{>a}(b)) \geq 1$. In either case \ref{constraint:stab} is satisfied for $ab$ as desired.  
\end{proof}
\section{Proof of Integrality}
\paragraph{}
In this section we build the necessary theory towards a proof that $P(G)$ is integral.
\subsection{Edges of Polytopes}
\paragraph{}
Before discussing the proof proper we need to take a slight detour to review some more elementary polyhedral geometry.
\begin{definition}
Let $x^1, x^2 \in \R^n$. Then $x \in \R^n$ is a convex combination of $x^1, x^2$ provided there exists $\lambda \in \R$ with $0 \leq \lambda \leq 1$ and $$x = \lambda x^1 + (1-\lambda)x^2.$$
\end{definition}
\begin{definition}
Let $P\subseteq \R^n$ be a polytope. Then the hyperplane given by $(h,\delta)$ is said to describe a valid inequality for $P$ if for all $x \in P$ $h^Tx \leq \delta$.
\end{definition}
\begin{definition}
Let $P \subseteq \R^n$ be a polytope. For our purposes we define an edge of $P$ to be a set $F$ of the form $$F = P \cap \{x \in \R^n: h^Tx \leq \delta \}$$ where $(h,\delta)$ describes a valid inequality for $P$, and there exists $x^1, x^2$ distinct vertices of $P$ for which all $x \in F$ are a convex combination of $x^1, x^2$.
\end{definition}
\begin{lemma}\label{lemma:edge-midpoint}
Let $P \subseteq \R^n$ be a polytope. Let $F$ be an edge of $P$ defined by valid inequality $(h,\delta)$ and extreme points $x^1, x^2$. Suppose there exist $y^1, y^2 \in \R^n$ not a convex combination of $x^1, x^2$ satisfying
$$\frac{1}{2}x^1 + \frac{1}{2} x^2 = \frac{1}{2} y^1 + \frac{1}{2}y^2.$$
Then at most one of $y^1, y^2 \in P$.
\end{lemma}
\begin{proof}
\paragraph{}
Let $$x = \frac{1}{2}x^1 + \frac{1}{2} x^2 = \frac{1}{2} y^1 + \frac{1}{2}y^2.$$ Suppose for a contradiction that $y^1,y^2 \in P$. Since $y^1, y^2 \not\in F$ we have
$$h^Ty^1 < \delta \quad\text{and}\quad h^Ty^2 < \delta. $$
So then,
\begin{align*}
h^Tx &= h^T(\frac{1}{2}y^1 + \frac{1}{2}y^2) \\
&= \frac{1}{2}h^Ty^1 + \frac{1}{2}h^Ty^2 \\
&< \frac{1}{2}\delta + \frac{1}{2}\delta \\
&= \delta.
\end{align*}
That is $h^T x < \delta$. But since $x = \frac{1}{2} x^1 + \frac{1}{2}x^2$, $x$ is a convex combination of $x^1, x^2$ and hence $x \in F$. That is $h^T x = \delta$, contradicting $h^T x < \delta$.
\end{proof}
\paragraph{}
Lemma \ref{lemma:edge-midpoint} say intuitively that line segments intersecting the midpoint of an edge of a polytope have at most one endpoint in $P$.
\subsection{Structural Lemmas}
\paragraph{}
In this section we describe some theory connecting the lattice structure of stable matchings described in \ref{SM:STRUCTURE} and the polytope $P(G)$. Going forward we assume that $E(G) \neq \emptyset$ as otherwise $P(G) = \emptyset$ is vacuously integral. Observe that this assumption implies that $0 \not\in P(G)$ as all constraints \ref{constraint:stab} are violated by $0$.
\begin{lemma}\label{lemma:all-same}
Let $M$ and $M'$ be distinct stable matchings in bipartite graph $G$ with preferences. If $\chi(M)$ and $\chi(M')$ are extreme points of $P(G)$ which define an edge of $P(G)$ then either $sup(M,M') = M$ (conversely $inf(M,M') = M'$) or $sup(M,M') = M'$ (conversely $inf(M,M') = M$).
\end{lemma}
\begin{proof}
\paragraph{}
Let $S = sup(M,M')$ and $I = inf(M,M')$. Suppose for a contradiction that $S \neq M$ and $S \neq M'$. That is, $S$ and $I$ are distinct stable matchings from $M$ and $M'$. We claim that
\begin{equation} \label{claim:chieq}
\chi(M) + \chi(M') = \chi(S) + \chi(I)
 \end{equation}
To see the claim, let $e \in E(G)$. If $e \in M \cap M'$ then the left hand side of $\ref{claim:chieq}$ is $2$, and further $e \in S \cap I$ and hence the right hand side of $\ref{claim:chieq}$ is $2$. If $e \not\in M \cap M'$ then both the left and right hand side of \ref{claim:chieq} is $0$. If $e \in M \backslash M'$ then either $e \in S$ or $e \in I$. In either case the left and right hand side of \ref{claim:chieq} is $1$, and the same holds for $e \in M' \backslash M$. That is the claim holds.
\paragraph{}
By the claim \ref{claim:chieq} we observe two things. First that
$$ \chi(M) + \chi(M') - \chi(S) = \chi(I) \neq 0$$
and hence $\chi(S)$ is linearly independent from $\chi(M), \chi(M')$. Similarly $\chi(I)$ is linearly independent from $\chi(M), \chi(M')$. Thus $\chi(S)$ and $\chi(I)$ and not convex combinations of $\chi(M), \chi(M')$. Second we observe that $$\frac{1}{2}\chi(M) + \frac{1}{2} \chi(M') = \frac{1}{2} \chi(S) + \frac{1}{2} \chi(I).$$
Therefore we are in a position to invoke lemma \ref{lemma:all-same}, concluding that one of $\chi(S), \chi(I) \not\in P(G)$. But this contradicts the lattice theorem \ref{theorem:lattice} since $S, I$ are stable matchings in $G$ implies that $\chi(S), \chi(I) \in P$  by lemma \ref{lemma:int-P}.
\end{proof}
\begin{corollary}\label{cor:edge} (Ratier) \cite{ratier1996stable}:
Let $M$ and $M'$ be distinct stable matchings in bipartite graph $G=(A\cup B, E)$ with preferences. If there exists $a \in A$ and $b \in B$ such that
\begin{equation}\label{cond:nonedge}
M \cap \delta^{>a}(b) \neq \emptyset,\ \ M\cap \delta^{>b}(a) \neq \emptyset \quad\text{and}\quad M' \cap(\delta^{>a}(b) \cup \delta^{>b}(a)) = \emptyset \end{equation}
then $\chi(M)$ and $\chi(M')$ do not define an edge of the polytope $P(G)$.
\end{corollary}
\begin{proof}
\paragraph{}
By condition \ref{cond:nonedge} we have $$M(a)>_a M'(a)$$ and $$M(b) >_b M'(b).$$
Since $M(a) >_a M'(a)$, $aM(a) \in \sup(M,M')$. That is $$sup(M,M') \cap M \neq \emptyset$$ and since $M'(a) \neq M(a)$, 
$$sup(M,M') \not\subseteq M'.$$
Since $M(b) >_b M'(b)$, $M'(b)b \in \sup(M,M')$. That is $$sup(M,M') \cap M' \neq \emptyset$$ and since $M(b) \neq M'(b)$,
$$sup(M,M') \not\subseteq M.$$
Taken together these observations prove that $sup(M,M')$ is a distinct stable matching from $M$ and $M'$. Thus by lemma \ref{lemma:all-same}, $\chi(M)$ and $\chi(M')$ do not define an edge of $P(G)$.  
\end{proof}
\subsection{Integrality of $P(G)$}
\paragraph{}
We are now ready to provide our proof that $P(G)$ is integral. The strategy is to first show that every extreme point $x$ has some variable $e \in E$ with $x_e \in \{0,1\}$, then, in a minimal counterexample, remove that variable and look at the reduced problem in the smaller variable set. By induction the vertices of the smaller polytope are integral. We will consider a particular edge of this polytope and obtain a contradiction via our structural lemmas of the previous section showing its end vertices cannot define an edge. The details will be made clear as we proceed.
\begin{lemma}\label{lemma:01}
Let $G = (A\cup B, E)$ be a bipartite graph with preferences. Let $x$ be an extreme point of $P(G)$. Then there exists $e \in E(G)$ such that $x_e \in \{0,1\}$.
\end{lemma}
\begin{proof}
\paragraph{}
Suppose for a contradiction that for all $e \in E(G)$, $0 <x_e < 1$. Recall by constraints \ref{constraint:nonneg} and \ref{constraint:one} that $0 \leq x_e \leq 1$ and so our assumption is sufficient for a contradiction. Since $x$ is a basic feasible solution (see section \ref{IR:LP}), $x$ is defined by $\size{E}$ linearly independent constraints which are tight (satisfied with equality) at $x$. Since $x > 0$ no such constraints are from type \ref{constraint:nonneg}. Thus all such constraints are from \ref{constraint:one} and \ref{constraint:stab}. Let $V_x \subseteq V(G)$ and $E_x \subseteq E(G)$ be such that $V_x$ and $E_x$ respectively contain vertices and edges corresponding to a set of $\size{E}$ linearly independent constraints tight at $x$. That is $V_x$ contains vertices corresponding to constraints from \ref{constraint:one} and $E_x$ contains edges corresponding to constraints from \ref{constraint:stab}. Choose $V_x$ and $E_x$ in such a way that $\size{V_x}x$ is maximized.
\paragraph{}
First observe that $V_x \subsetneq V$. To see this, suppose that $V_x = V$. Then since $G$ is bipartite
$$\sum_{a \in A} \chi(\delta(a)) = \sum_{b \in B} \chi(\delta(b))$$
and hence $\{\chi(\delta(v)) : v \in V=V_x\}$ is not linearly independent. Thus our observation that $V_x \subsetneq V$ holds.
\paragraph{}
For any $v \in V(G)$ denote by $N(v)$ the set $\{ w \in V(G): vw \in \delta(v)\}$ and let $N_{max}(v) \in N(v)$ be such that $N_{max}(v) \geq_v w$ for all $w \in N(v)$. Similarly let $N_{min}(v) \in N(v)$ be such that $N_{min}(v) \leq_v w$ for all $w \in N(v)$.
\paragraph{}
Let $b \in B$. We claim that if $a = N_{max}(b)$ then $ab \not\in E_x$. Indeed suppose for a contradiction that $ab \in E_x$. Since $a = N_{max}(b)$, $\delta^{>a}(b) = \emptyset$ and hence
$$1 \leq x(\delta^{>a}(b)) + x(\delta^{>b}(a)) + x_{ab}  = x(\delta^{\geq b}(a) \leq x(\delta(a)) \leq 1,$$
shows that $1 = x(\delta^{\geq b}(a)$ and thus $x(\delta^{<b}(a) = 0$. Since $x_e > 0$ for all $e \in E(G)$ this implies that $\delta^{<b}(a) = \emptyset$. Therefore
$$\chi(\delta(a)) = \chi(\delta^{\geq b}(a)) = \chi(\delta^{>a}(b)) + \chi(\delta^{>b}(a)) + \chi(\{ab\})$$
and hence by linear independence we cannot have both $ab \in E_x$ and $a \in V_x$. Since $ab \in E_x$ this implies $a \not\in V_x$. But then the sets $V_x \cup\{a\}$ and $E_x \backslash\{ab\}$ describe the same vectors as $V_x, E_x$ but $\size{V_x \cup\{a\}} > \size{V_x}$ contradicting our choice of $V_x$. Thus $ab \not\in E_x$. Similarly we can show that $aN_{max} \not\in E_x$. Therefore for any $v \in V$, $vN_{max}(v) \not\in E_x$.
\paragraph{}
Let $v \in V_x$. Let $w = N_{min}(v)$. We claim analogously to the previous claim that $vw \not\in E_x$ (this time we will show it without mention of $A$,$B$). Indeed suppose for a contradiction that $vw  \in E_x$. Since $v \in V_x$, by tightness,
$$x(\delta(v)) = 1$$
and since $vw \in E_x$, by tightness,
$$x(\delta^{>v}(w)) + x(\delta^{>w}(v)) + x_{vw} = 1.$$
Since $w = N_{min}(v)$, $\delta^{>w}(v) \cup \{vw\} = \delta(v)$ and hence
$$x(\delta^{>w}(v)) + x_{vw} = x(\delta(v)$$
and
$$\chi(\delta^{>w}(v)) + \chi(\{vw\}) = \chi(\delta(v)).$$
Thus
$$1 = x(\delta^{>v}(w)) + x(\delta^{>w}(v)) + x_{vw} = x(\delta^{>v}(w)) + x(\delta(v)) = x(\delta^{>v}(w)) + 1,$$
which implies that $x(\delta^{>v}(w)) = 0$. Again since $x_e > 0$ for all $e \in E(G)$, this implies that
$$\chi(\delta^{>v}(w)) = 0.$$
So we have that
$$\chi(\delta(v)) = \chi(\delta^{>w}(v)) + \chi(\{vw\}) = \chi(\delta^{>v}(w)) + \chi(\delta^{>w}(v)) + \chi(\{vw\}),$$
and hence by linear independence we cannot have both $vw \in E_x$ and $v \in V_x$. Since $v \in V_x$ this implies $vw \not\in E_x$, a contradiction.
\end{proof}