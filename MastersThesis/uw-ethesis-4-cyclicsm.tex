%======================================================================
\chapter{Cyclic Stable Matching}
%======================================================================
This chapter describes the cyclic stable matching problem as posed by Knuth. We give some sufficient conditions for a matching to be stable in this context. Then we proceed to describe a computer search procedure for deciding if all preference systems of a certain size have a cyclic stable matching or finding a counterexample should one exist. 
\section{The Problem}
\paragraph{}
In Knuth's writing on stable matching \cite{knuth1997stable} he talks about some extensions of the classical stable matching problems as discussed so far. One such avenue for generalization is increasing the number of "genders", which is to say increase instead of matching pairs, we consider matching triples in tripartite graphs or matching $k$-tuples in $k$-partite graphs. We will make this notion formal through the terminology of hypergraphs.
\begin{definition}
We $G=(V,E)$ is a hypergraph if $V$ is some discrete set and $E \subseteq 2^V$ ($2^V$ denotes the set of all subsets of elements in $V$). We can think of adjacency in this case as $v \sim w$ provided there exists $e \in E$ such that $v, w \in e$. The notions of degree $d$ and edges incident upon a vertex $\delta$ extend naturally. A matching in this context is $M \subseteq E$ such that for all $m_1, m_2 \in M$, $m_1 \cap m_2 = \emptyset$. We call $G$ $k$-uniform if for all $e \in E$, $|e| = k$. We call $k$-uniform $G$ $k$-partite if there exists $V_1, \dots, V_k$ which partition $V$ and for all $e=(v_1, \dots, v_k) \in E$, $v_i \in V_i$ for $i = 1,\dots, k$. Lastly we say $k$-partite graph $G$ is balanced if $\size{V_1} = \dots = \size{V_k}$.
\end{definition}
\paragraph{}
With our description hypergraphs complete we are ready to describe a generalization of stable matching.
\begin{definition}
In an instance of cyclic $k$-gender stable matching ($CkGSM$), we are given a $k$-partite hypergraph $G=(V_0 \cup \dots \cup V_{k-1}, E)$ and for each $i \in \{0,\dots,k-1\}$, each $v_i \in V_i$ is equipped with a preference order over $V_{i+1} \cap V(\delta(v_i))$ where addition of indices is taken modulo $k$ (so $V_{k-1}$ vertices have preferences over $V_0$ vertices, hence the descriptor cyclic). That each vertex in a given gender has preferences over vertices acceptable to them in another gender. We say our instance, and naturally the hypergraph $G$, is complete if for all $v_0 \in V_0$, $\dots$, $v_{k-1} \in V_{k-1}$, $(v_0,\dots,v_{k-1}) \in E$ (all possible tuples are acceptable to use in matchings). A solution to an instance of $CkGSM$ is a matching $M \subseteq E$ that is stable in the sense that no blocking tuple exists. A tuple $e=(v_0,\dots, v_{k-1}) \in E$ blocks $M$ if $e\not\in M$ and for each $i \in \{0,\dots, k-1\}$, $v_{i+1} >_{v_i} M(v_i)$ where $M(v_i)$ denotes the vertex $v_{i+1} \in V_{i+1}$ such that there exists an edge $m \in M$ for which $v_i, v_{i+1} \in m$.
\end{definition}
\begin{note}
We may assume that instances of $CkGSM$ are balanced. To see this observe that adding dummy vertices does not affect the solutions. Thus if $\size{V_i} < \size{V_j}$ we can add $\size{V_j} - \size{V_i}$ dummy vertices to $V_i$ to balance their sizes. If incomplete preferences are allowed then dummy vertices can simply have no incoming edges. If preferences are required to be complete then we may simply place dummy vertices as the least preferred vertices among the relevant preference lists and give the dummy vertices arbitrary orders over "real" vertices they face. We that an instance of $CkGSM$ is of size $n$ if it is balanced with each $V_i$ having size $n$.
\end{note}
\paragraph{}
We will focus on instances where $k=3$ to simplify things somewhat. Knuth asked if instances of $C3GSM$ always have solutions. To this day this question is unresolved for complete instances. Some, but not many, results are known and we will present them in the next section.
\begin{conjecture}\label{conj:stab}
For all sizes $n$, instances of $C3GSM$ of size $n$ have a stable matching.
\end{conjecture} 
\section{Known Results}
\paragraph{}
First we will present a counterexample that demonstrates that when instances are not complete there need not always be a stable matching solution. This example is due to Biro et al \cite{biro2010three} and shows that when you have incomplete preferences there is a hypergraph with each $V_i$ have size $6$ and preference lists that admit no stable matching.
\begin{note}\label{ex:R6}
For our counterexample consider the tripartite hypergraph $R6 = (A \cup B \cup C, E)$ where $$A = \{a_1,a_2,a_3,a_1',a_2',a_3'\},\ B = \{b_1,b_2,b_3,b_1',b_2',b_3'\},\ \text{and}\ C = \{c_1,c_2,c_3,c_1',c_2',c_3'\}.$$ Below we present the preference orders of each vertex, where vertices omitted from a list are deemed unacceptable and cannot form edges with the given vertex whose list is under consideration:
\begin{align*}
a_0 &: b_0 > b_0' &b_0: c_0 > c_0' &\ &c_0:a_1 > a_1'\\
a_1 &: b_1 > b_1' &b_1: c_1 > c_1' &\ &c_1:a_2 > a_2'\\
a_2 &: b_2 > b_2' &b_2: c_2 > c_2' &\ &c_2: a_0> a_0'\\
a_0' &: b_2 &b_0': c_2 &\ &c_0':a_0 \\
a_1'&: b_0 &b_1': c_0 &\ &c_1':a_1\\
a_2' &:b_1 &b_2': c_1 &\ & c_1':a_2.
\end{align*}
We will adopt the notation of the original authors calling the agents $\{a_i, b_i, c_i: 1 \leq i \leq 3 \}$ the inner agents and $\{a_i',b_i',c_i': 1\leq i \leq 3\}$ the outer agents.
\end{note}.
\begin{lemma}
The problem instance of $C3GSM$ described in note \ref{ex:R6} has no stable matching.
\end{lemma}
\begin{proof}
Let $M$ be a matching in $R6$. We observe that the possible triples in $M$ have very particular forms. Let $m \in M$ be a triple. Suppose that inner vertex $a_i \in m$. Then by $a_i$'s preferences either $b_i \in m$ or $b_i' \in m$. If $b_i \in m$ then as $a_i$ is not acceptable to $c_i$, the triple $m$ is of the form $a_ib_ic_i'$. If $b_i' \in m$ then $c_{i-1} \in m$ (recall index addition and subtraction is done modulo $3$) and hence the triple $m$ is of the form $a_i b_i'c_{i-1}$. Otherwise if outer vertex $a_i' \in m$ then the triple $m$ is of the form $a_i'b_{i-1}c_{i-1}$. That is the only triples in $M$ are those of the form
$$a_ib_ic_i' \quad\text{or}\quad a_ib_i'c_{i-1} \quad\text{or}\quad a_i'b_{i-1}c_{i-1}.$$
Then triples in $M$ contain exactly two inner agents and one outer agent each. Since each agent can only be matched at most once, and inner agents are matched in pairs then $M$ matches an even number of inner agents. But there are an odd number ($9$) of inner agents. Hence at least one inner agent is unmatched in $M$. By the symmetry of the problem instance we may assume without loss of generality that this inner agent is $a_i$. Consider the triple $T=(a_i, b_{i}', c_{i-1})$. If $c_{i-1}$ is matched in $M$ then, as $a_i$ is unmatched, $M(c_{i-1}) = a_i'$. Hence $a_i >_{c_{i-1}} M(c_{i-1})$. Again since $a_i$ is unmatched, $b_{i}'$ is unmatched and thus prefers $T$ to $M$. Hence the triple $T$ blocks $M$, and since $M$ was an arbitrary matching no matching of $R6$ is stable.
\end{proof}
\paragraph{}
Since we have a counterexample to stability in the case where incomplete preferences are allowed this motivates us to restrict the problem to the situation where problem instances are complete. It is in this setting that we will work going forward. As of yet we are not aware of any counterexample instance that has no stable matching for complete $C3GSM$, nor of any proof that all instances admit a stable matching.
\paragraph{}
One natural angle towards a proof would be to attempt to extend the Deferred-Acceptance algorithm of Gale and Shapley to $C3GSM$. Farczadi et al provide some insight into the feasibility of this route in \cite{farczadi2014stable}. Here they claim a particular approach to extending Deferred-Acceptance is $NP$-complete. For readers without a complexity theory background this result gives strong evidence that there is no polynomial time algorithm for the approach to extending Deferred-Acceptance that they examine.
\begin{theorem}
(Farczadi et al): Consider an instance of complete $C3GSM$ with hypergraph $G=(A\cup B\cup C, E)$. Fix a perfect matching of $A$ to $B$. The problem of deciding if this matching can be extended to a stable matching of $G$ is $NP$-complete.
\end{theorem}
\paragraph{}
So in lieu of algorithmic insight into the problem, researchers have presented ad-hoc methods to demonstrate when instances of $C3GSM$ are stable for fixed sizes $n$. It has been shown by Eriksson et al \cite{eriksson2006three} that complete instances of size $n \leq 4$ always have a stable matching. First observe that cases of size $n \leq 2$ are not interesting as blocking triples are impossible since a blocking triple must draw each of its vertices from a distinct triple in the matching (no vertices in instances of $C3GSM$ are unmatched in a stable matching, as they would come in threes and prefer to be together than unmatched). The case for $n=3$ is straightforward and requires a bit of case analysis, but Eriksson et al have shown something stronger that we will prove instead. Before we state the lemma, we will give some quick notation that will make discussing the lemma and proof much more convenient.
\begin{definition}
Let $G=(A\cup B \cup C, E)$ be the hypergraph for an instance of $C3GSM$. We will define the following functions for $A$ but we will use analogous versions for $B$ and $C$ throughout. Let $S\subseteq B$. Let $a \in A$. Then $f(a, S) = b$ provided $b \in B$ and for all $b' \in B \backslash S$, $b>_a b'$. In other words $f(a,S)$ maps $a$ and $S$ to the most preferred vertex in $B$ ignoring those in $S$. Let $s \in \{1,\dots,n-1\}$. If $s=1$ define $f(a,s) = b$ provided $f(a,\{b\}) = b$. If $s>1$ define $f(a,s) = b$ provided $f(a,\{b\}\cup\{f(a,t): t\in\{1,\dots,s-1\}) = b$. Intuitively $f(a,s)$ is $a$'s $s$-th choice among vertices in $B$.
\end{definition}
\begin{definition}
Let $G = (A \cup B \cup C, E)$ be the hypergraph for an instance of $C3GSM$. We say $G$ has an $i,j,k$ triple if there exist $a \in A$, $b\in B$, and $c \in C$ such that $f(a,i) = b$, $f(b,j) = c$, and $f(c,k) = a$. Of particular interest are $1,1,1$ triples. If a matching contains a $1,1,1$ triple then none of the vertices in the triple will participate in any blocking triple against the matching.
\end{definition}
\begin{lemma}\label{lemma:n3}
(Eriksson et al) \cite{eriksson2006three}: Let $G=(A\cup B \cup C, E)$ be the hypergraph for an instance of $C3GSM$ of size $3$. Let $a \in A$. Then $G$ has a stable matching $M$ where either $M(a)= f(a,1)$ or, $M(a) = f(a,2)$ and $M(b) = f(b,1)$ where $b = f(a,1)$.
\end{lemma}
\begin{proof}
\paragraph{} First consider the case where $G$ has a $1,1,1$ triple $(a',b',c')$. Construct the matching $M$ as follows. Add $a'b'c'$ to $M$. Now $a',b',c'$ will not participate in any blocking triples against $M$. Hence there are only $6$ vertices remaining, so regardless of how we choose the next two triples for $M$ the resulting matching will be stable. If $a = a'$ then we are done, so we may assume $a\neq a'$. If $b = b'$ then complete $M$ arbitrarily as long as $M(a) = f(a,2)$. Otherwise, $b\neq b'$ and we may complete $M$ arbitarily ensuring $M(a) = b$.
\paragraph{} Now consider the case where $G$ has no $1,1,1$ triple. Let $c = f(b,1)$. Since there is no $1,1,1$ triple, $a \neq f(c,1)$. Let $a' = f(c,1)$. Again since there is no $1,1,1$ triple $b \neq f(a',1)$. Let $b' = f(a',1)$. Similarly $c \neq f(b',1)$ and et $c' = f(b',1)$. Let $a'', b'', c''$ be the remaining vertices in $A,B,C$ respectively. Form the matching $M = \{abc,a'b'c',a''b''c''\}$. We claim $M$ is stable. Since $a$ and $a'$ were matched to their first choices they will not participate in any blocking triple. Hence $a''$ is the only vertex in $A$ willing to participate in a blocking triple. But $a'$ is only unmatched to $b$ and $b'$, both of which are matched to their first choices and hence are unwilling to participate in any blocking triple. Thus there are no blocking triples against $M$ and hence $M$ is stable. Further since $M(a) = b$ we are done. 
\end{proof}
\paragraph{}
Using lemma \ref{lemma:n3} Eriksson et al show the following theorem. We ommit the proof as, by the authors own admission, it is a technical case analysis.
\begin{theorem}(Eriksson et al) \label{theorem:n4} \cite{eriksson2006three}: The conjecture \ref{conj:stab} holds for $n\leq 4$.
\end{theorem}
\section{Our Contributions}
\paragraph{}
In this section we will describe some work done towards resolving if $C3GSM$ instances always have solutions for higher sizes $n$. We present first some sufficient conditions for problem instances to have stable matchings. Next we study the symmetry of problem instances and describe when problem instances are equivalent with respect to having a stable matching. All this work is building towards a proposal for a computer search procedure to decide if all instances of $C3GSM$ for a given size $n$ have a stable matching, or present a counterexample if they do not.
\subsection{Sufficient Conditions}
\begin{definition}
Let $G$ be the hypergraph for an instance of $C3GSM$, and let $M$ be a matching in $G$. We denote by $\cB(G,M)$ the set of blocking triples in $G$ against $M$. Formally $\cB(G,M) = \{abc \in E(G): b>_a M(a), c>_b M(b), a>_c M(c)\}$.
\end{definition}
\begin{note}
If we let $S \subseteq V(G)$ and denote by $G[S]$ the hypergraph $G$ restricted to vertices in $S$ and edges between vertices in $S$ ($G[S]$ denotes the subgraph induced by $S$) then we may use $\cB(G[S],M)$ to describe the blocking triples of $G$ among vertices in $S$. In particular if we wish to study blocking triples present among agents matched in $M$ we study the set $\cB(G[V(M)], M)$.
\end{note}
\begin{lemma}\label{lemma:partialstab}
Let $G = (A\cup B \cup C, E)$ be the hypergraph for an instance of $C3GSM$ of size $n$ where $n-1$ is the best known size such that  satisfies conjecture \ref{conj:stab}. Suppose that $G$ has a matching $M$ (note $M$ need not be perfect) for which $\cB(G[V(M)],M) = \emptyset$. If for all  $v \in V(M)$, for all $w \in V(G)$ such that $w >_v M(v)$, we have that $w \in V(M)$ then $G$ has a stable matching.
\end{lemma}
\begin{proof}
\paragraph{}
Let $G' = G[V(G)\backslash V(M)]$ be the hypergraph obtained by removing vertices matched in $M$ from $G$. Consider the instance of $C3GSM$ with underlying hypergraph $G'$ and preference orders obtained from $G$. Since the size the instance with $G' \leq n=1$ we can find a stable matching of $G'$, call it $M'$. Consider the perfect matching in $G$ given by $S = M \cup M'$. We claim that $S$ is stable for $G$. Suppose for a contradiction that there exists $(a,b,c) \in \cB(G, S)$. Since $M'$ is stable for $G'$ and $\cB(G[V(M)], M) = \emptyset$, the blocking triple $(a,b,c)$ must use both agents matched in $M$ and $M'$. That is, at least one of $a,b,c \in V(M')$ and at least one of $a,b,c \in V(M)$. Bear in mind $V(M) \cap V(M') = \emptyset$. Without loss suppose $a \in V(M)$. Since $(a,b,c)$ is a blocking triple, $b >_a S(a) = M(a)$. Then by our hypothesis $b$ is matched in $M$. Again, since $(a,b,c)$ is a blocking triple, $c >_b S(b) = M(b)$ and by our hypothesis $c$ is matched in $M$. So $a,b,c \in V(M)$, a contradiction as this implies $a,b,c \not\in M'$ violating that at least one of $a,b,c \in M'$.
\end{proof}
\begin{corollary}\label{cor:1cycle}
Let $G$ be the hypergraph for an instance of $C3GSM$ and $n$ be as in lemma \ref{lemma:partialstab}. If there exists $a,b,c \in V(G)$ such that $b = f(a,1)$, $c = f(b,1)$, and $a = f(c,1)$ then $G$ has a stable matching.
\end{corollary}
\begin{proof}
\paragraph{}
Invoke lemma \ref{lemma:partialstab} with $M = \{(a,b,c)\}$.
\end{proof}
\begin{corollary}
Let $G=(A\cup B \cup C, E)$ be the hypergraph for an instance of $C3GSM$ with $n$ as in lemma \ref{lemma:partialstab}. If one of $A,B,C$, say without loss $A$, is such that for all $a,a' \in A$, $f(a,1) = f(a',1)$ then $G$ has a stable matching.
\end{corollary}
\begin{proof}
\paragraph{}
Let $a_1, \dots, a_n \in A$. Supppose that $b = f(a_1,1) =  \dots = f(a_n,1)$. Let $c = f(b,1)$. Then there exists some $a_k$ such that $a_k = f(c,1)$. Since $a_k \in A$ we may invoke corollary \ref{cor:1cycle} with $(a_k, b, c)$ to complete the proof.
\end{proof}
\subsection{Symmetry in Problem Instances}

\subsection{Computer Search}
